# 离线电子现金

离线电子现金就是可以脱离银行实时监视进行支付的电子现金，它是目前正在进行的科研项目。离线电子现金要保证

1. 进行支付时，银行不在场。
2. 支付完毕后，银行再参与资金清算。
3. 一旦发现重复使用的电子现金，就能够追踪重复使用者的身份。未重复使用的电子现金，使用者的身份不会暴露。

第①和第②是很容易保证的。困难在于第③。银行或商家不能预先获得顾客的秘密身份信息，必须恰好在顾客两次花费同一个电子现金之后才能获得顾客的秘密身份信息。

公钥密码原理使这个问题得以解决，解决方案就是 `Schnorr`协议（为了方便理解，这里只介绍 `Schnorr`协议的简化版）。

---

### `Schnorr`协议

在`Schnorr`协议的初始化阶段，选择一个大素数 `p`，一个正整数 `g`。其中， ` p`和`g`都被公开

设顾客的身份秘密信息是(m, b)，其中m和b都是正整数。由身份秘密信息生成顾客的身份公开信息是(c, n)。生成公式如下所示：

$$
c=g^b(modp)； n=g^m(modp)
$$
| 公开信息     | n 和 c |
| ------------ | :----: |
| 身份密码信息 | m 和 b |

`Schnorr`支付协议如下：

第一步：顾客出示电子现金。电子现金上有其身份公开信息(c, n)。

第二步：商家随机地选择一个正整数x，发送给顾客。（询问）

第三步：顾客用自己的身份秘密信息(m, b)，计算：$y=mx+b \ (mod \ p-1)$。顾客将 y 发送给商家。（回答）

第四步：商家用顾客的身份公开信息(c, n)，验证是否有
$$
g^y \equiv n^{x}c \ (mod \ p)
$$
若成立则接受这个电子现金；否则拒绝接受该电子现金。（检验）

### `Schnorr`支付协议的分析

##### 结果一

知道身份秘密信息 (m, b) 的人将通过检验。换句话说，用(m, b)计算出来的 $y=mx+b (mod \ p-1)$将通过检验。这是因为
$$
g^y \equiv g^{mx+b}(modp) \equiv g^{mx}g^b(modp) \equiv n^{x}c(modp)。
$$
（这里使用了数论的一个基本结论：当 $y=mx+b(modp-1) $时，必有 $g^y=g^{mx+b}(modp)$）

##### 结果二

一次使用该电子现金不会暴露顾客的身份秘密信息(m, b)。

商家知道了顾客的身份公开信息(c, n)，又通过询问值 x得到了顾客的回答值 y。商家还知道x与y的关系为： 
$$
y=mx+b(modp-1)
$$
但是商家计算出(m, b)的途径只能有两条：

第一条途径，是通过方程组
$$
{c=g^b(modp)， n=g^m(modp)}
$$
计算(m, b)，该计算问题是**离散对数问题**，逆求解是困难的。

第二条途径，是通过方程 $y=mx+b(modp-1)$来计算(m, b)。该方程无法唯一地解出(m, b)。

##### 结果三

两次使用该电子现金将暴露顾客的身份秘密信息(m, b)。

第一次使用该电子现金，询问值/回答值 为 (x,y)

第二次使用该电子现金，询问值/回答值 为 (u,v)

于是商家获得了两个方程：
$$
y=mx+b(modp-1)； v=mu+b(modp-1)
$$
这是一个“二元一次方程组”，解出的值为：
$$
m=(v-y)(u-x)^{-1}(modp-1)； b=v-mu(modp-1)
$$

##### 结果四

同一个顾客所使用的不同的电子现金，应该含有该顾客的不同的身份公开信息，隐含该顾客的不同的身份秘密信息。否则，设该顾客的若干电子现金都含有其同一个身份公开信息 (c, n)，隐含其同一个身份秘密信息(m, b)。

该顾客如果在同一个商家使用了两个不同的电子现金，则该商家就能计算出(m, b)

顾客使用一个电子现金时，询问值/回答值为(x,y)。顾客使用另一个电子现金时，询问值/回答值为(u,v)。于是商家获得了两个方程：
$$
y=mx+b(modp-1)； v=mu+b(modp-1)；
$$
(m, b)容易解出。

因此，顾客要想大量地使用电子现金，就要准备大量的身份秘密信息。这是不现实的。这也是`Schnorr`支付协议的致命缺陷之一。

##### 结果五

顾客的原始欺骗无法防止。顾客在申请电子现金时，完全可以选择无关紧要的信息 (m, b)作为“身份秘密信息”，然后计算对应的“身份公开信息”(c, n)，将(c, n)发送给银行。如果银行认可，并发放电子现金，则当顾客重复使用电子现金时，所揭露的“身份秘密信息”(m, b)并不能使该顾客受到惩罚。

那么，在顾客申请电子现金时，银行怎样确认顾客的身份信息？这里有两个相互矛盾的要求：

- 银行不能获得顾客的身份秘密信息，只能获得顾客提交的身份公开信息。
- 银行从顾客提交的身份公开信息中，能够辨别顾客是否隐含了真正的身份秘密信息。